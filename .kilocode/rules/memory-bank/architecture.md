# lipunto - Архитектура

## Системная архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Глобальные    │    │   Shell скрипты  │    │   Python скрипт │
│   Горячие клави │    │   (обертки)      │    │   (ядро)        │
│  ши (KDE)       │    │                 │    │                 │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │  Pause      │ │    │ │ sw_last.sh  │ │    │ │switch_layout│ │
│ │  Shift+Pause│ │    │ │ sw_selected.sh│ │    │ │.py          │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Системные     │
                    │   утилиты       │
                    │                 │
                    │ ┌─────────────┐ │
                    │ │   ydotool   │ │
                    │ │   qdbus     │ │
                    │ │   kdialog   │ │
                    │ └─────────────┘ │
                    └─────────────────┘
```

## Исходный код и компоненты

### Основные файлы проекта

1. **[`switch_layout.py`](switch_layout.py)** - Основной Python скрипт
   - Содержит словари для преобразования символов (en_ru, ru_en)
   - Реализует функции для работы с буфером обмена и эмуляции ввода
   - Обрабатывает два режима работы: "last" и "selected"
   - Интегрируется с KDE через qdbus и ydotool

2. **[`sw_last.sh`](sw_last.sh)** - Скрипт для коррекции последнего слова
   - Устанавливает права сокета ydotool
   - Вызывает switch_layout.py с параметром "last"

3. **[`sw_selected.sh`](sw_selected.sh)** - Скрипт для коррекции выделенного текста
   - Устанавливает права сокета ydotool
   - Вызывает switch_layout.py с параметром "selected"

4. **[`lipunto.kksrc`](lipunto.kksrc)** - Конфигурация KDE
   - Определяет глобальные горячие клавиши
   - Привязывает Pause к sw_last.sh
   - Привязывает Shift+Pause к sw_selected.sh

5. **[`input-event-codes.h`](input-event-codes.h)** - Заголовочный файл
   - Содержит коды клавиш Linux
   - Используется для эмуляции ввода через ydotool

### Ключевые функции и компоненты

#### Преобразование текста

- [`switch_text_layout()`](switch_layout.py:47) - Основная функция преобразования
- [`en_ru`](keyboard_layouts.py:7) и [`ru_en`](keyboard_layouts.py:77) - словари для замены символов

#### Работа с буфером обмена

- [`get_selection()`](clipboard_utils.py:128) - Получение выделенного текста
- [`paste_text()`](clipboard_utils.py:148) - Вставка текста
- [`save_clipboard_history()`](clipboard_utils.py:98) - Сохранение содержимого буфера

#### Эмуляция ввода

- [`select_last_word()`](switch_layout.py:136) - Выделение последнего слова
- [`run_ydotool_command()`](switch_layout.py:117) - Выполнение команд ydotool
- [`run_qbus_command()`](switch_layout.py:125) - Выполнение команд qdbus

#### Пользовательский интерфейс

- [`show_popup_message()`](switch_layout.py:88) - Показ уведомлений через kdialog

## Критические пути выполнения

### Путь 1: Коррекция последнего слова

1. Нажатие Pause
2. Вызов sw_last.sh
3. Вызов switch_layout.py last
4. Выделение последнего слова (Ctrl+Shift+Left)
5. Копирование в буфер (Ctrl+C)
6. Преобразование текста
7. Вставка преобразованного текста (Shift+Insert)
8. Переключение раскладки
9. Показ уведомления

### Путь 2: Коррекция выделенного текста

1. Нажатие Shift+Pause
2. Вызов sw_selected.sh
3. Вызов switch_layout.py selected
4. Копирование выделенного текста (Ctrl+C)
5. Преобразование текста
6. Вставка преобразованного текста (Shift+Insert)
7. Переключение раскладки
8. Показ уведомления

## Технические зависимости

### Внешние утилиты

- **ydotool** - для эмуляции ввода клавиш
- **qdbus** - для работы с буфером обмена KDE
- **kdialog** - для отображения уведомлений

### Системные требования

- Python 3.13.5
- KDE Plasma (для глобальных горячих клавиш)
- Доступ к /tmp/.ydotool_socket

## Коды клавиш (используются в ydotool)

- 29: Ctrl
- 42: Shift
- 46: C (Copy)
- 105: Left (←)
- 110: Insert (Paste)

## Обработка ошибок

- Проверка наличия всех необходимых утилит
- Обработка ошибок выполнения команд
- Визуальное уведомление об ошибках через kdialog

## Настройка отображения уведомлений

- Опциональное отображение уведомлений после конвертации текста
- Настройка через аргументы командной строки
- Поддержка глобальных настроек через конфигурационный файл
